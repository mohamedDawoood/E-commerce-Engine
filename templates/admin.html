<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CORE | Unified Admin Command</title>
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.321.0/dist/umd/lucide.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&display=swap');
        
        :root {
            --primary: #ff0033;
            --primary-dark: #cc0029;
            --bg: #050505;
            --card: #0d0d0d;
            --border: rgba(255, 255, 255, 0.08);
            --text-main: #ffffff;
            --text-muted: #a1a1aa;
            --success: #00ff88;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: var(--bg); color: var(--text-main); font-family: 'Plus Jakarta Sans', sans-serif; display: flex; min-height: 100vh; overflow-x: hidden; }

        /* Sidebar */
        .sidebar { width: 280px; background: #080808; border-right: 1px solid var(--border); padding: 40px 20px; position: fixed; height: 100vh; display: flex; flex-direction: column; z-index: 100; }
        .brand { font-size: 24px; font-weight: 800; margin-bottom: 50px; letter-spacing: -1px; }
        .brand span { color: var(--primary); }
        
        .nav-group { margin-bottom: 30px; }
        .nav-label { font-size: 11px; text-transform: uppercase; color: var(--text-muted); letter-spacing: 1px; margin-bottom: 15px; display: block; }
        
        .nav-link { display: flex; align-items: center; gap: 12px; padding: 14px 18px; color: var(--text-muted); text-decoration: none; border-radius: 14px; margin-bottom: 8px; transition: all 0.3s; cursor: pointer; border: 1px solid transparent; }
        .nav-link:hover { background: rgba(255, 255, 255, 0.03); color: white; }
        .nav-link.active { background: rgba(255, 0, 51, 0.1); color: white; border-color: rgba(255, 0, 51, 0.2); }

        /* Main Content */
        .main-wrapper { margin-left: 280px; padding: 40px; width: calc(100% - 280px); }
        .header-box { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; }
        
        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .stat-card { background: var(--card); border: 1px solid var(--border); padding: 25px; border-radius: 20px; display: flex; flex-direction: column; gap: 10px; }
        .stat-card i { color: var(--primary); }
        .stat-val { font-size: 28px; font-weight: 800; }
        .stat-label { color: var(--text-muted); font-size: 14px; }

        /* Sections */
        .section { display: none; animation: slideUp 0.4s ease forwards; }
        .section.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Tables & Forms */
        .data-card { background: var(--card); border: 1px solid var(--border); border-radius: 24px; padding: 30px; overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px; color: var(--text-muted); font-size: 12px; text-transform: uppercase; border-bottom: 1px solid var(--border); }
        td { padding: 18px 15px; border-bottom: 1px solid var(--border); font-size: 14px; vertical-align: middle; }
        
        .user-badge { background: rgba(0, 255, 136, 0.1); color: var(--success); padding: 4px 10px; border-radius: 8px; font-size: 12px; font-weight: 600; }
        .admin-badge { background: rgba(255, 0, 51, 0.1); color: var(--primary); padding: 4px 10px; border-radius: 8px; font-size: 12px; font-weight: 600; }
        
        .prod-img { width: 50px; height: 50px; border-radius: 12px; object-fit: cover; }
        
        .input-group { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        input, textarea { background: #000; border: 1px solid var(--border); padding: 14px 18px; border-radius: 12px; color: white; outline: none; transition: 0.3s; width: 100%; }
        input:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(255, 0, 51, 0.1); }

        .btn { padding: 14px 28px; border-radius: 12px; font-weight: 700; cursor: pointer; transition: 0.3s; border: none; display: flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-2px); }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); padding: 8px 16px; font-size: 13px; }
        .btn-outline:hover { background: var(--primary); color: white; }

        .loading-overlay { position: fixed; inset: 0; background: var(--bg); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    </style>
</head>
<body>

    <div id="loader" class="loading-overlay">
        <div style="width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animate: spin 1s linear infinite;"></div>
    </div>

    <div class="sidebar">
        <div class="brand">CORE<span>.</span>SYSTEM</div>
        
        <div class="nav-group">
            <span class="nav-label">Overview</span>
            <div class="nav-link active" onclick="switchTab('users', this)"><i data-lucide="users"></i> Users Control</div>
            <div class="nav-link" onclick="switchTab('products', this)"><i data-lucide="package"></i> Inventory</div>
        </div>

        <div class="nav-link" onclick="logout()" style="margin-top: auto; color: #ff4444; border-color: rgba(255, 68, 68, 0.2);"><i data-lucide="log-out"></i> System Exit</div>
    </div>

    <div class="main-wrapper">
        <div class="header-box">
            <h1 id="sectionTitle">User Management</h1>
            <div id="adminName" style="color: var(--text-muted); font-weight: 600;">Admin Terminal</div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <i data-lucide="users"></i>
                <span class="stat-val" id="statUsers">0</span>
                <span class="stat-label">Total Accounts</span>
            </div>
            <div class="stat-card">
                <i data-lucide="shopping-bag"></i>
                <span class="stat-val" id="statProducts">0</span>
                <span class="stat-label">Active Products</span>
            </div>
        </div>

        <div id="users" class="section active">
            <div class="data-card">
                <table>
                    <thead>
                        <tr><th>User Identity</th><th>Email Address</th><th>Access Level</th><th>Operations</th></tr>
                    </thead>
                    <tbody id="userTableBody"></tbody>
                </table>
            </div>
        </div>

        <div id="products" class="section">
            <div class="data-card" style="margin-bottom: 30px;">
                <h3 style="margin-bottom: 20px;">Deploy New Product</h3>
                <form id="productForm">
                    <div class="input-group">
                        <input type="text" id="pName" placeholder="Product Title" required>
                        <input type="number" id="pPrice" placeholder="Unit Price ($)" step="0.01" required>
                        <input type="number" id="pStock" placeholder="Initial Stock" required>
                        <input type="file" id="pImage" accept="image/*" required>
                    </div>
                    <textarea id="pDesc" placeholder="Product specification and details..." rows="3" style="margin-bottom: 20px;"></textarea>
                    <button type="submit" class="btn btn-primary"><i data-lucide="upload-cloud"></i> Push to Store</button>
                </form>
            </div>

            <div class="data-card">
                <table>
                    <thead>
                        <tr><th>Asset</th><th>Name</th><th>Price</th><th>Availability</th><th>Actions</th></tr>
                    </thead>
                    <tbody id="productTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Security Guard
        const token = localStorage.getItem('token');
        const role = localStorage.getItem('role');

        if (!token || role !== 'admin') {
            window.location.replace('/users/login');
        }

        // Global State
        lucide.createIcons();
        window.onload = () => {
            document.getElementById('loader').style.display = 'none';
            loadUsers();
            loadProducts();
        };

        function switchTab(tabId, el) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            el.classList.add('active');
            document.getElementById('sectionTitle').innerText = tabId === 'users' ? 'User Management' : 'Inventory Control';
        }

        async function apiFetch(url, options = {}) {
            const res = await fetch(url, {
                ...options,
                headers: { ...options.headers, 'Authorization': `Bearer ${token}` }
            });
            if (res.status === 401) logout();
            return res;
        }

async function loadUsers() {
    try {
        const res = await apiFetch('/users/admin');
        const users = await res.json();
        document.getElementById('statUsers').innerText = users.length;
        document.getElementById('userTableBody').innerHTML = users.map(u => {
            // حل مشكلة الـ toUpperCase بتحديد قيمة افتراضية لو الـ role مش موجود
            const userRole = u.role ? u.role.toUpperCase() : "USER"; 
            return `
                <tr>
                    <td><div style="font-weight:700">${u.username}</div><div style="font-size:11px; color:var(--text-muted)">UID: ${u.id}</div></td>
                    <td>${u.email}</td>
                    <td><span class="${u.role === 'admin' ? 'admin-badge' : 'user-badge'}">${userRole}</span></td>
                    <td><button class="btn btn-outline" onclick="deleteUser(${u.id})">Terminate</button></td>
                </tr>
            `;
        }).join('');
    } catch (e) {
        console.error("Error loading users:", e);
    }
}

async function loadProducts() {
    try {
        const res = await apiFetch('/products/');
        const products = await res.json();
        document.getElementById('statProducts').innerText = products.length;
        document.getElementById('productTableBody').innerHTML = products.map(p => `
            <tr>
                <td><img src="/${p.image_url}" class="prod-img" onerror="this.src='https://placehold.co/50x50/000000/FFF/png'"></td>
                <td><div style="font-weight:700">${p.name}</div></td>
                <td>$${p.price}</td>
                <td><span style="color:${p.stock > 0 ? 'var(--success)' : 'var(--primary)'}">${p.stock} units</span></td>
                <td><button class="btn btn-outline" onclick="deleteProduct(${p.id})">Destroy</button></td>
            </tr>
        `).join('');
    } catch (e) {
        console.error("Error loading products:", e);
    }
}
        document.getElementById('productForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            btn.innerText = "Processing...";
            btn.disabled = true;

            const formData = new FormData();
            formData.append('name', document.getElementById('pName').value);
            formData.append('price', document.getElementById('pPrice').value);
            formData.append('stock', document.getElementById('pStock').value);
            formData.append('description', document.getElementById('pDesc').value);
            formData.append('file', document.getElementById('pImage').files[0]);

            const res = await apiFetch('/products/', { method: 'POST', body: formData });
            
            btn.innerText = "Push to Store";
            btn.disabled = false;

            if(res.ok) {
                document.getElementById('productForm').reset();
                loadProducts();
                alert("Product Deployed Successfully!");
            }
        };

        async function deleteUser(id) {
            if(confirm("Permanent Identity Termination?")) {
                await apiFetch(`/users/admin_delete_user/${id}`, { method: 'DELETE' });
                loadUsers();
            }
        }

        async function deleteProduct(id) {
            if(confirm("Confirm Asset Destruction?")) {
                await apiFetch(`/products/${id}`, { method: 'DELETE' });
                loadProducts();
            }
        }

        function logout() {
            localStorage.clear();
            window.location.replace('/users/login');
        }
    </script>
</body>
</html>